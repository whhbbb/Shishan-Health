{"version":3,"file":"http.js","sources":["../../../../src/utils/http.ts"],"sourcesContent":["import { useMemberStore } from '@/stores'\r\n\r\nconst httpInterceptor = {\r\n  // 拦截前触发\r\n  invoke(options: UniApp.RequestOptions) {\r\n    // 非http开头拼接\r\n    if (!options.url.startsWith('http')) {\r\n      options.url = 'https://124.220.216.249:3266' + options.url\r\n    }\r\n    options.timeout = 10000\r\n    // 添加小程序请求头标识\r\n    options.header = {\r\n      ...options.header,\r\n      // 'source-client': 'miniapp'\r\n    }\r\n    // 添加token请求头标识\r\n    const token = uni.getStorageSync('token')\r\n    if (token) {\r\n      options.header.Authorization = `Bearer ${token}`\r\n    }\r\n  },\r\n}\r\n\r\n// 拦截request请求\r\nuni.addInterceptor('request', httpInterceptor)\r\n// 拦截uploadFile请求\r\nuni.addInterceptor('uploadFile', httpInterceptor)\r\n\r\n//白名单 不需要验证token\r\nconst whiteList = [\r\n  '/pages/index/index',\r\n  '/pages/login/login',\r\n  '/pages/column/column',\r\n  '/pages/column/components/article',\r\n  '/pages/recommend/recommend',\r\n  '/pages/recommend/recommendDetail',\r\n  '/pages/activity/ActivityDetails',\r\n  '/pages/my/components/contactUs',\r\n  '/pages/my/components/aboutUs',\r\n  '/pages/gift/giftCenter',\r\n]\r\n//登录页\r\nconst loginPage = '/pages/login/login'\r\nconst initPermission = {\r\n  invoke(e) {\r\n    // 调用前拦截\r\n    console.log('拦截', e)\r\n    //获取用户的token\r\n    const token = uni.getStorageSync('token'),\r\n      //获取要跳转的页面路径（url去掉\"?\"和\"?\"后的参数）\r\n      url = e.url.split('?')[0]\r\n    const notNeed = whiteList.includes(url)\r\n    // 如果在whiteList里面就不需要登录\r\n    if (notNeed) {\r\n      return e\r\n    } else {\r\n      //需要登录\r\n      if (!token) {\r\n        uni.showToast({\r\n          title: '请先登录',\r\n          icon: 'none',\r\n          duration: 1000,\r\n          complete: () => {\r\n            setTimeout(() => {\r\n              uni.navigateTo({\r\n                url: loginPage,\r\n              })\r\n            }, 1000)\r\n          },\r\n        })\r\n\r\n        return false\r\n      } else {\r\n        return e\r\n      }\r\n    }\r\n  },\r\n  fail(err) {\r\n    // 失败回调拦截\r\n    console.log(err)\r\n  },\r\n}\r\n//页面跳转拦截器\r\nuni.addInterceptor('navigateTo', initPermission)\r\nuni.addInterceptor('switchTab', initPermission)\r\nuni.addInterceptor('reLaunch', initPermission)\r\nuni.addInterceptor('redirectTo', initPermission)\r\n\r\ntype Data<T> = {\r\n  code: string\r\n  msg: string\r\n  result: T\r\n}\r\n\r\nexport const http = <T>(options: UniApp.RequestOptions) => {\r\n  return new Promise<T>((resolve, reject) => {\r\n    uni.request({\r\n      ...options,\r\n      success(res) {\r\n        //登陆过期\r\n        console.log(res)\r\n        if (res.statusCode == 200 && res.data.code == 410) {\r\n          uni.showToast({\r\n            title: '登录过期',\r\n            icon: 'none',\r\n            duration: 1000,\r\n            complete: () => {\r\n              setTimeout(() => {\r\n                uni.removeStorageSync('token')\r\n                uni.navigateTo({\r\n                  url: '/pages/login/login',\r\n                })\r\n              }, 1000)\r\n            },\r\n          })\r\n          reject(res)\r\n        }\r\n\r\n        if (res.statusCode >= 200 && res.statusCode < 300) {\r\n          resolve(res.data as T)\r\n        } else if (res.statusCode === 401) {\r\n          uni.navigateTo({\r\n            url: '/pages/login/login',\r\n          })\r\n          reject(res)\r\n        } else {\r\n          uni.showToast({\r\n            icon: 'none',\r\n            title: (res.data as Data<T>).msg || '请求失败',\r\n          })\r\n          reject(res)\r\n        }\r\n      },\r\n      fail(err) {\r\n        uni.showToast({\r\n          icon: 'none',\r\n          title: err.errMsg || '网络错误，请换个网络试试',\r\n        })\r\n        reject(err)\r\n      },\r\n    })\r\n  })\r\n}\r\n"],"names":["uni"],"mappings":"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"}